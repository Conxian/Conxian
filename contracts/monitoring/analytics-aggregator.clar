;; analytics-aggregator.clar;; COMPREHENSIVE FINANCIAL ANALYTICS SYSTEM;; Traditional Finance Metrics: EBITDA, AUM, ARR, MNAV, ROE, ROA;; DeFi Metrics: Real Yield, POL, Revenue/TVL, Sticky TVL;; Risk Metrics: Sharpe Ratio, Sortino Ratio, VaR, Max Drawdown;; User Metrics: CAC, LTV, Retention, Churn;; Treasury Metrics: Runway, Burn Rate, Reserve Ratio;; ===== Constants =====(define-constant ERR_UNAUTHORIZED (err u5001))(define-constant ERR_INVALID_METRIC (err u5002))(define-constant ERR_DIVISION_BY_ZERO (err u5003))(define-constant ERR_INSUFFICIENT_DATA (err u5004))(define-constant PRECISION u1000000000000000000) ;; 1e18(define-constant BASIS_POINTS u10000) ;; 100%(define-constant BLOCKS_PER_DAY u144) ;; ~24 hours(define-constant BLOCKS_PER_YEAR u52560) ;; ~365 days(define-constant DAYS_PER_YEAR u365);; Metric types(define-constant METRIC_TVL u1)(define-constant METRIC_VOLUME_24H u2)(define-constant METRIC_APY u3)(define-constant METRIC_USER_COUNT u4)(define-constant METRIC_TRANSACTION_COUNT u5)(define-constant METRIC_AUM u6)(define-constant METRIC_ARR u7)(define-constant METRIC_EBITDA u8)(define-constant METRIC_REAL_YIELD u9)(define-constant METRIC_POL u10);; ===== Data Variables =====(define-data-var contract-owner principal tx-sender)(define-data-var metrics-updater principal tx-sender);; Global protocol metrics(define-data-var total-value-locked uint u0)(define-data-var total-volume-24h uint u0)(define-data-var total-users uint u0)(define-data-var total-transactions uint u0);; Financial metrics(define-data-var protocol-owned-liquidity uint u0)(define-data-var treasury-balance uint u0)(define-data-var monthly-burn-rate uint u0)(define-data-var token-emissions uint u0);; ===== Metric Storage =====;; Traditional Finance Metrics (EBITDA, AUM, ARR, etc.)(define-map financial-metrics uint {  ;; Revenue metrics  gross-revenue: uint,  operating-expenses: uint,  ebitda: uint,  ;; Earnings Before Interest, Taxes, Depreciation, Amortization  net-income: uint,  ;; Asset metrics  aum: uint,  ;; Assets Under Management (TVL)  nav-per-share: uint,  ;; Net Asset Value per share  mnav: uint,  ;; Modified Net Asset Value  ;; Revenue multiples  arr: uint,  ;; Annual Recurring Revenue  mrr: uint,  ;; Monthly Recurring Revenue  revenue-run-rate: uint,  ;; Profitability ratios  operating-margin: uint,  ;; EBITDA / Revenue (bps)  net-margin: uint,  ;; Net Income / Revenue (bps)  roe: uint,  ;; Return on Equity (bps)  roa: uint,  ;; Return on Assets (bps)  ;; Efficiency ratios  revenue-per-user: uint,  revenue-per-tvl: uint,  ;; Revenue / TVL ratio (bps)  period: uint});; DeFi-Specific Metrics(define-map defi-metrics uint {  ;; Yield metrics  real-yield: uint,  ;; Excluding token emissions  nominal-yield: uint,  ;; Including emissions  emission-value: uint,  ;; Liquidity metrics  protocol-owned-liquidity: uint,  mercenary-capital: uint,  ;; TVL - sticky TVL  sticky-tvl: uint,  ;; TVL held >30 days  liquidity-depth: uint,  ;; Token metrics  token-velocity: uint,  ;; Volume / Market Cap  fdv: uint,  ;; Fully Diluted Valuation  market-cap: uint,  mcap-to-tvl: uint,  ;; Market Cap / TVL (bps)  ;; Protocol health  revenue-to-tvl: uint,  ;; Fee Revenue / TVL (bps)  utilization-rate: uint,  ;; Borrowed / Supplied (bps)  treasury-to-tvl: uint,  ;; Treasury / TVL (bps)  period: uint});; Per-asset TVL(define-map asset-tvl principal {  amount: uint,  usd-value: uint,  last-updated: uint});; Per-pool metrics(define-map pool-metrics principal {  tvl: uint,  volume-24h: uint,  fee-revenue-24h: uint,  apy: uint,  utilization: uint,  last-updated: uint});; Per-vault metrics(define-map vault-metrics principal {  total-assets: uint,  total-shares: uint,  apy: uint,  performance-fee: uint,  last-harvest: uint});; Historical snapshots (daily)(define-map daily-snapshots uint {  date: uint,  tvl: uint,  volume: uint,  users: uint,  transactions: uint,  avg-apy: uint});; User analytics(define-map user-metrics principal {  total-deposits: uint,  total-withdrawals: uint,  total-fees-paid: uint,  total-rewards-earned: uint,  last-active: uint});; Protocol revenue tracking(define-map revenue-metrics uint {  trading-fees: uint,  performance-fees: uint,  liquidation-fees: uint,  flash-loan-fees: uint,  total-revenue: uint});; Risk Metrics (Sharpe, Sortino, VaR, Max Drawdown)(define-map risk-metrics uint {  ;; Volatility metrics  volatility: uint,  ;; Standard deviation (bps)  downside-volatility: uint,  ;; Downside deviation (bps)  max-drawdown: uint,  ;; Maximum peak-to-trough decline (bps)  current-drawdown: uint,  ;; Risk-adjusted returns  sharpe-ratio: uint,  ;; (Return - Risk-free) / Volatility  sortino-ratio: uint,  ;; (Return - Risk-free) / Downside Vol  calmar-ratio: uint,  ;; Return / Max Drawdown  ;; Value at Risk  var-95: uint,  ;; 95% confidence VaR (bps)  var-99: uint,  ;; 99% confidence VaR (bps)  cvar-95: uint,  ;; Conditional VaR (Expected Shortfall)  ;; Concentration risk  herfindahl-index: uint,  ;; Sum of squared market shares  concentration-ratio: uint,  ;; % in top 3 assets (bps)  ;; Liquidity risk  bid-ask-spread: uint,  ;; Average spread (bps)  liquidity-score: uint,  ;; 0-10000  period: uint});; User Acquisition & Retention Metrics(define-map user-cohort-metrics uint {  ;; Acquisition  new-users: uint,  total-active-users: uint,  dau: uint,  ;; Daily Active Users  wau: uint,  ;; Weekly Active Users  mau: uint,  ;; Monthly Active Users  ;; Retention  retention-rate-d7: uint,  ;; 7-day retention (bps)  retention-rate-d30: uint,  ;; 30-day retention (bps)  retention-rate-d90: uint,  ;; 90-day retention (bps)  churn-rate: uint,  ;; Monthly churn (bps)  ;; Economics  cac: uint,  ;; Customer Acquisition Cost  ltv: uint,  ;; Lifetime Value  ltv-to-cac: uint,  ;; LTV / CAC ratio  avg-revenue-per-user: uint,  ;; Engagement  avg-transactions-per-user: uint,  power-user-percentage: uint,  ;; Top 10% users (bps)  whale-percentage: uint,  ;; >$100k users (bps)  period: uint});; Treasury & Sustainability Metrics(define-map treasury-metrics uint {  ;; Balance sheet  treasury-balance: uint,  protocol-owned-liquidity: uint,  reserve-assets: uint,  total-liabilities: uint,  ;; Sustainability  monthly-revenue: uint,  monthly-expenses: uint,  burn-rate: uint,  ;; Expenses - Revenue (if negative)  runway-months: uint,  ;; Treasury / Burn Rate  ;; Reserve ratios  reserve-ratio: uint,  ;; Reserves / Liabilities (bps)  coverage-ratio: uint,  ;; Assets / Liabilities (bps)  solvency-ratio: uint,  ;; Capital efficiency  capital-deployed: uint,  ;; % of treasury earning yield  treasury-yield: uint,  ;; Yield on treasury assets (bps)  period: uint});; ===== Authorization =====(define-private (check-is-owner)  (ok (asserts! (is-eq tx-sender (var-get contract-owner)) ERR_UNAUTHORIZED)))(define-private (check-is-updater)  (ok (asserts! (or (is-eq tx-sender (var-get contract-owner))                    (is-eq tx-sender (var-get metrics-updater)))                ERR_UNAUTHORIZED)));; ===== Update Functions =====(define-public (update-asset-tvl (asset principal) (amount uint) (usd-value uint))  (begin    (try! (check-is-updater))    (map-set asset-tvl asset {      amount: amount,      usd-value: usd-value,      last-updated: block-height    })    (ok true)))(define-public (update-pool-metrics  (pool principal)  (tvl uint)  (volume-24h uint)  (fee-revenue-24h uint)  (apy uint)  (utilization uint))  (begin    (try! (check-is-updater))    (map-set pool-metrics pool {      tvl: tvl,      volume-24h: volume-24h,      fee-revenue-24h: fee-revenue-24h,      apy: apy,      utilization: utilization,      last-updated: block-height    })    (ok true)))(define-public (update-vault-metrics  (vault principal)  (total-assets uint)  (total-shares uint)  (apy uint)  (performance-fee uint))  (begin    (try! (check-is-updater))    (map-set vault-metrics vault {      total-assets: total-assets,      total-shares: total-shares,      apy: apy,      performance-fee: performance-fee,      last-harvest: block-height    })    (ok true)))(define-public (record-user-activity  (user principal)  (deposit-amount uint)  (withdrawal-amount uint)  (fees-paid uint)  (rewards-earned uint))  (begin    (try! (check-is-updater))    (match (map-get? user-metrics user)      existing      (map-set user-metrics user {        total-deposits: (+ (get total-deposits existing) deposit-amount),        total-withdrawals: (+ (get total-withdrawals existing) withdrawal-amount),        total-fees-paid: (+ (get total-fees-paid existing) fees-paid),        total-rewards-earned: (+ (get total-rewards-earned existing) rewards-earned),       