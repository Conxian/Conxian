;; Liquidation Manager Contract;; Implements liquidation functionality for the lending protocol(use-trait liquidation-trait .all-traits.liquidation-trait)
(impl-trait liquidation-trait);; ==================== CONSTANTS ====================(define-constant CONTRACT_OWNER tx-sender)(define-constant MAX_POSITIONS_PER_BATCH u10);; ==================== DATA VARIABLES ====================(define-data-var admin principal CONTRACT_OWNER)(define-data-var liquidation-paused bool false)(define-data-var liquidation-incentive-bps u200)  ;; 2% default incentive(define-data-var close-factor-bps u5000)          ;; 50% default close factor;; Contract references(define-data-var lending-system (optional principal) none);; Whitelisted assets for liquidation(define-map whitelisted-assets { asset: principal } { is-whitelisted: bool });; ==================== ADMIN FUNCTIONS ====================(define-public (set-admin (new-admin principal))  (begin    (asserts! (is-eq tx-sender (var-get admin)) (err u1002))    (var-set admin new-admin)    (ok true)  ))(define-public (set-lending-system (system principal))  (begin    (asserts! (is-eq tx-sender (var-get admin)) (err u1002))    (var-set lending-system (some system))    (ok true)  ))(define-public (set-liquidation-incentive (incentive-bps uint))  (begin    (asserts! (is-eq tx-sender (var-get admin)) (err u1002))    (asserts! (<= incentive-bps u1000) (err u1003))  ;; Max 10% incentive    (var-set liquidation-incentive-bps incentive-bps)    (ok true)  ))(define-public (set-close-factor (factor-bps uint))  (begin    (asserts! (is-eq tx-sender (var-get admin)) (err u1002))    (asserts! (<= factor-bps u10000) (err u1003))  ;; Max 100%    (var-set close-factor-bps factor-bps)    (ok true)  ))(define-public (set-paused (paused bool))  (begin    (asserts! (is-eq tx-sender (var-get admin)) (err u1002))    (var-set liquidation-paused paused)    (ok true)  ))(define-public (whitelist-asset (asset principal) (whitelisted bool))  (begin    (asserts! (is-eq tx-sender (var-get admin)) (err u1002))    (map-set whitelisted-assets { asset: asset } { is-whitelisted: whitelisted })    (ok true)  ));; ==================== LIQUIDATION FUNCTIONS ====================(define-read-only (is-liquidatable (user principal) (debt-asset principal) (collateral-asset principal))  (match (can-liquidate-position user debt-asset collateral-asset)    (ok result) (ok result)    error error  ))(define-read-only (can-liquidate-position (borrower principal) (debt-asset principal) (collateral-asset principal))  (let (      (lending-system (unwrap! (var-get lending-system) (err u1008)))      (debt-whitelisted (default-to false (get is-whitelisted (map-get? whitelisted-assets { asset: debt-asset }))))      (collateral-whitelisted (default-to false (get is-whitelisted (map-get? whitelisted-assets { asset: collateral-asset }))))    )    (asserts! debt-whitelisted (err u1008))    (asserts! collateral-whitelisted (err u1008))        (match (contract-call? lending-system is-position-underwater borrower debt-asset collateral-asset)      result (ok result)      error error    )  ))(define-public (liquidate-position  (borrower principal)  (debt-asset principal)  (collateral-asset principal)  (debt-amount uint)  (max-collateral-amount uint))  (let (      (lending-system (unwrap! (var-get lending-system) (err u1008)))      (debt-whitelisted (default-to false (get is-whitelisted (map-get? whitelisted-assets { asset: debt-asset }))))      (collateral-whitelisted (default-to false (get is-whitelisted (map-get? whitelisted-assets { asset: collateral-asset }))))    )    (asserts! (not (var-get liquidation-paused)) (err u1001))    (asserts! debt-whitelisted (err u1008))    (asserts! collateral-whitelisted (err u1008))    (match (calculate-liquidation-amounts borrower debt-asset collateral-asset debt-amount)      (ok amounts)        (let ((collateral-to-seize (get collateral-to-seize amounts)))          (asserts! (<= collateral-to-seize max-collateral-amount) (err u1005))                    (match (contract-call? lending-system liquidate borrower debt-asset collateral-asset debt-amount collateral-to-seize)            (ok result) (ok {              debt-repaid: (get debt-repaid result),              collateral-seized: (get collateral-seized result),              liquidation-fee: (get liquidation-fee result)            })            error error          )        )      error error    )  ))(define-public (liquidate-multiple-positions  (positions (list 10 (tuple    (borrower principal)    (debt-asset principal)    (collateral-asset principal)    (debt-amount uint)  ))))  (let (      (lending-system (unwrap! (var-get lending-system) (err u1008)))      (positions-count (len positions))    )    (asserts! (not (var-get liquidation-paused)) (err u1001))    (asserts! (<= positions-count MAX_POSITIONS_PER_BATCH) (err u1007))    (fold liquidate-single-position      positions      { success-count: u0, total-debt-repaid: u0, total-collateral-seized: u0 }    )  ))(define-private (liquidate-single-position  (position (tuple (borrower principal) (debt-asset principal) (collateral-asset principal) (debt-amount uint)))  (acc (tuple (success-count uint) (total-debt-repaid uint) (total-collateral-seized uint)))  )  (let (      (borrower (get borrower position))      (debt-asset (get debt-asset position))      (collateral-asset (get collateral-asset position))      (debt-amount (get debt-amount position))    )    (match (liquidate-position borrower debt-asset collateral-asset debt-amount u1000000000000)      (ok result)        (merge acc {          success-count: (+ (get success-count acc) u1),          total-debt-repaid: (+ (get total-debt-repaid acc) (get debt-repaid result)),          total-collateral-seized: (+ (get total-collateral-seized acc) (get collateral-seized result))        })      error acc    )  ))(define-read-only (calculate-liquidation-amounts  (borrower principal)  (debt-asset principal)  (collateral-asset principal)  (debt-amount uint))  (let ((lending-system (unwrap! (var-get lending-system) (err u1008))))    (match (contract-call? lending-system get-liquidation-amounts borrower debt-asset collateral-asset debt-amount)      (ok amounts) (ok {        max-debt-repayable: (get max-debt-repayable amounts),        collateral-to-seize: (get collateral-to-seize amounts),        liquidation-incentive: (get liquidation-incentive amounts),        debt-value: (get debt-value amounts),        collateral-value: (get collateral-value amounts)      })      error error    )  ))(define-public (emergency-liquidate  (borrower principal)  (debt-asset principal)  (collateral-asset principal))  (begin    (asserts! (is-eq tx-sender (var-get admin)) (err u1002))    (let ((lending-system (unwrap! (var-get lending-system) (err u1008))))      (contract-call? lending-system emergency-liquidate borrower debt-asset collateral-asset)    )  ))